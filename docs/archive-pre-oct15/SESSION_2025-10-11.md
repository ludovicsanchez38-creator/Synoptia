# üìù Session du 11 octobre 2025 - Fix Cluster Nodes LangChain

**Date** : 11 octobre 2025 (13h00 - 14h00)
**Objectif** : Corriger la g√©n√©ration des workflows LangChain (cluster nodes)
**Impact** : 7/9 workflows cass√©s ‚Üí Fix appliqu√©

---

## üéØ PROBL√àME IDENTIFI√â

Les **nodes LangChain** sont des **cluster nodes** (ROOT + SUB-NODES) qui n√©cessitent une architecture sp√©ciale:
- **Root nodes** (AI Agent, Chains) : peuvent avoir des parameters
- **Sub-nodes** (LLM, Memory, Embeddings) : DOIVENT avoir `parameters: {}`
- **Connexions sp√©ciales** : `ai_languageModel`, `ai_memory`, etc. (PAS "main")

**Cause** : Les 3 agents (Planning, Generator, Supervisor) ne connaissaient pas cette architecture.

---

## ‚úÖ TRAVAIL R√âALIS√â

### 1. Modifications des prompts (3 agents)

#### Planning Agent (`rag/pipeline/planning-agent.js`)
- **Lignes modifi√©es** : ~290-388
- **Ajout** : Section compl√®te sur l'architecture cluster nodes
- **D√©tection** : Mots-cl√©s pour identifier quand utiliser AI Agent
- **Impact** : Le planning d√©tecte maintenant les besoins en cluster nodes

#### Generator Agent (`rag/pipeline/rag-enhanced-generator.js`)
- **Lignes modifi√©es** : ~623-831
- **Ajout** :
  - R√®gles strictes sur `parameters: {}` pour sub-nodes
  - Exemples complets de workflows corrects
  - Types de connexions sp√©ciales (ai_*)
- **Impact** : G√©n√©ration correcte de l'architecture cluster nodes

#### Supervisor Agent (`rag/pipeline/supervisor-agent.js`)
- **Lignes modifi√©es** : ~392-459
- **Ajout** :
  - Validation que sub-nodes ont `parameters: {}`
  - V√©rification des types de connexions
  - Checklist de validation compl√®te
- **Impact** : Rejet des workflows mal structur√©s

### 2. Enrichissement du RAG

**Script cr√©√©** : `scripts/index-real-n8n-workflows.js`

**R√©sultats** :
```
‚úÖ 50 workflows index√©s avec succ√®s
‚è≠Ô∏è  2 workflows skipp√©s (sans nodes)
ü§ñ 11 workflows avec LangChain
üìä RAG: 2509 ‚Üí 2559 embeddings (+50 workflows)
```

**Impact** : Le RAG dispose maintenant de vrais exemples de workflows LangChain fonctionnels.

---

## üìä AVANT / APR√àS

| Aspect | Avant | Apr√®s |
|--------|-------|-------|
| **Sub-nodes parameters** | Remplis (‚ùå) | Vides `{}` (‚úÖ) |
| **Connexions** | "main" partout (‚ùå) | Types sp√©ciaux `ai_*` (‚úÖ) |
| **Architecture** | Lin√©aire (‚ùå) | Cluster ROOT+SUB (‚úÖ) |
| **RAG** | 2509 embeddings | 2559 (+50 workflows) |
| **Workflows cass√©s** | 7/9 (78%) | Tests en cours |

---

## üîß STRUCTURE CORRECTE

### Exemple workflow chatbot avec m√©moire

```json
{
  "nodes": [
    {
      "parameters": {"httpMethod": "POST"},
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "id": "webhook-1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "Tu es un assistant utile."
      },
      "name": "AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "id": "agent-1"
    },
    {
      "parameters": {},  // ‚Üê VIDE!
      "name": "OpenAI Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "id": "llm-1"
    },
    {
      "parameters": {},  // ‚Üê VIDE!
      "name": "Simple Memory",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "id": "memory-1"
    }
  ],
  "connections": {
    "Webhook": {
      "main": [[{"node": "AI Agent", "type": "main", "index": 0}]]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [[{"node": "AI Agent", "type": "ai_languageModel", "index": 0}]]
    },
    "Simple Memory": {
      "ai_memory": [[{"node": "AI Agent", "type": "ai_memory", "index": 0}]]
    },
    "AI Agent": {
      "main": [[{"node": "Respond", "type": "main", "index": 0}]]
    }
  }
}
```

**Architecture** :
```
Webhook ‚Üí AI Agent (root) ‚Üí Respond
             ‚Üë (ai_languageModel) OpenAI Model
             ‚Üë (ai_memory) Memory
```

---

## üìù FICHIERS MODIFI√âS

1. `/home/ludo/synoptia-workflow-builder/rag/pipeline/planning-agent.js`
2. `/home/ludo/synoptia-workflow-builder/rag/pipeline/rag-enhanced-generator.js`
3. `/home/ludo/synoptia-workflow-builder/rag/pipeline/supervisor-agent.js`
4. `/home/ludo/synoptia-workflow-builder/scripts/index-real-n8n-workflows.js` (cr√©√©)

---

## üöÄ PROCHAINE √âTAPE

**Tests √† effectuer** :
1. Chatbot Telegram avec m√©moire
2. RAG avec Qdrant
3. RGPD Information Extractor
4. Blog Content Ingestion

**Commande pour tester** :
```bash
curl -X POST http://localhost:3002/api/generate \
  -H "Content-Type: application/json" \
  -d '{"request": "VOTRE_PROMPT_ICI"}'
```

---

## üìã CHECKLIST

- [x] Planning Agent modifi√©
- [x] Generator Agent modifi√©
- [x] Supervisor Agent modifi√©
- [x] Script d'indexation cr√©√©
- [x] 50 workflows index√©s dans RAG
- [ ] Tests g√©n√©ration chatbot
- [ ] Tests g√©n√©ration RAG
- [ ] Tests g√©n√©ration RGPD
- [ ] Tests g√©n√©ration Blog
- [ ] Import dans N8N et validation

---

## üí° NOTES TECHNIQUES

### Types de connexions LangChain

| Sub-node Type | Connection Type |
|---------------|----------------|
| LLM (OpenAI Chat Model) | `ai_languageModel` |
| Memory (Buffer, Postgres) | `ai_memory` |
| Embeddings | `ai_embedding` |
| Vector Store (Qdrant) | `ai_vectorStore` |
| Output Parser | `ai_outputParser` |
| Tools (Calculator, Code) | `ai_tool` |
| Document Loader | `ai_document` |
| Text Splitter | `ai_textSplitter` |

### Root nodes disponibles

- `@n8n/n8n-nodes-langchain.agent` (AI Agent) ‚Üê PRINCIPAL
- `@n8n/n8n-nodes-langchain.chainLlm` (Basic LLM Chain)
- `@n8n/n8n-nodes-langchain.chainSummarization` (Summarization Chain)
- `@n8n/n8n-nodes-langchain.informationExtractor` (Information Extractor)
- `@n8n/n8n-nodes-langchain.textClassifier` (Text Classifier)

---

## üîç COMMANDES UTILES

```bash
# V√©rifier nombre d'embeddings dans Qdrant
curl -s http://localhost:6333/collections/synoptia_knowledge | jq '.result.points_count'

# R√©indexer les workflows existants
node scripts/index-real-n8n-workflows.js /tmp/existing-workflows.json

# D√©marrer le serveur
bash -c 'set -a && source .env && set +a && PORT=3002 node server.js' > /tmp/server.log 2>&1 &

# Tester g√©n√©ration
curl -X POST http://localhost:3002/api/generate \
  -H "Content-Type: application/json" \
  -d '{"request": "Cr√©er un chatbot..."}'

# Voir les logs
tail -f /tmp/server.log
```

---

**Statut** : ‚úÖ Modifications appliqu√©es, tests en cours
